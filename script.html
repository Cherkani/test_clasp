<script>
const AppState = {
  view: 'documents',
  clients: [],
  providers: [],
  products: [],
  documents: [],
  documentItems: [],
  documentTypes: [],
  documentStatuses: [],
  isSaving: false,
  errorMessage: ''
};

const API = {
  getAppData() {
    return new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(() => resolve({
          clients: [], providers: [], products: [], documents: [], documentItems: []
        }))
        .getAppData();
    });
  },
  addClient(payload) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).addClient(payload);
    });
  },
  updateClient(payload) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).updateClient(payload);
    });
  },
  deleteClient(id) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).deleteClient(id);
    });
  },
  addProvider(payload) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).addProvider(payload);
    });
  },
  updateProvider(payload) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).updateProvider(payload);
    });
  },
  deleteProvider(id) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).deleteProvider(id);
    });
  },
  addProduct(payload) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).addProduct(payload);
    });
  },
  updateProduct(payload) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).updateProduct(payload);
    });
  },
  deleteProduct(id) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).deleteProduct(id);
    });
  },
  addDocument(document, items) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).addDocument(document, items);
    });
  },
  updateDocument(document, items) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).updateDocument(document, items);
    });
  },
  deleteDocument(id) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).deleteDocument(id);
    });
  }
};

function formatCurrency(value) {
  return Number(value || 0).toFixed(2);
}

function setView(view) {
  AppState.view = view;
  renderApp();
}

function renderApp() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="layout">
      <aside class="sidebar">
        <h1>Client CRM</h1>
        ${renderNavButton('documents', 'Documents')}
        ${renderNavButton('clients', 'Clients')}
        ${renderNavButton('products', 'Products')}
        ${renderNavButton('providers', 'Providers')}
        ${AppState.isSaving ? renderSidebarLoader() : ''}
      </aside>
      <main class="content">
        ${renderView()}
      </main>
    </div>
  `;
}

function renderSidebarLoader() {
  return `
    <div class="sidebar-loader">
      <div class="spinner"></div>
      <div>Saving changes...</div>
    </div>
  `;
}

function renderNavButton(view, label) {
  return `<button class="nav-button ${AppState.view === view ? 'active' : ''}" onclick="setView('${view}')">${label}</button>`;
}

function renderView() {
  switch (AppState.view) {
    case 'clients':
      return renderClients();
    case 'products':
      return renderProducts();
    case 'providers':
      return renderProviders();
    default:
      return renderDocuments();
  }
}

function renderClients() {
  const rows = AppState.clients.map(client => `
    <tr>
      <td>${client.name}</td>
      <td>${client.email}</td>
      <td>${client.phone}</td>
      <td>${client.address}</td>
      <td class="actions">
        <button class="button secondary" onclick="editClient(${client.id})">Edit</button>
        <button class="button secondary" onclick="removeClient(${client.id})">Delete</button>
      </td>
    </tr>
  `).join('');

  return `
    <section class="panel">
      <h2>Clients</h2>
      ${renderClientForm()}
    </section>
    <section class="panel">
      <table>
        <thead>
          <tr><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Actions</th></tr>
        </thead>
        <tbody>${rows || '<tr><td colspan="5">No clients yet.</td></tr>'}</tbody>
      </table>
    </section>
  `;
}

function renderClientForm(client = {}) {
  return `
    <div class="form-grid">
      <div>
        <label>Name</label>
        <input id="client-name" value="${client.name || ''}" />
      </div>
      <div>
        <label>Email</label>
        <input id="client-email" value="${client.email || ''}" />
      </div>
      <div>
        <label>Phone</label>
        <input id="client-phone" value="${client.phone || ''}" />
      </div>
      <div>
        <label>Address</label>
        <input id="client-address" value="${client.address || ''}" />
      </div>
      <div>
        <label>Notes</label>
        <textarea id="client-notes">${client.notes || ''}</textarea>
      </div>
    </div>
    <div>
      <button class="button" onclick="saveClient(${client.id || ''})">${client.id ? 'Update' : 'Add'} Client</button>
    </div>
  `;
}

function renderProviders() {
  const rows = AppState.providers.map(provider => `
    <tr>
      <td>${provider.name}</td>
      <td>${provider.email}</td>
      <td>${provider.phone}</td>
      <td>${provider.address}</td>
      <td class="actions">
        <button class="button secondary" onclick="editProvider(${provider.id})">Edit</button>
        <button class="button secondary" onclick="removeProvider(${provider.id})">Delete</button>
      </td>
    </tr>
  `).join('');

  return `
    <section class="panel">
      <h2>Providers</h2>
      ${renderProviderForm()}
    </section>
    <section class="panel">
      <table>
        <thead>
          <tr><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Actions</th></tr>
        </thead>
        <tbody>${rows || '<tr><td colspan="5">No providers yet.</td></tr>'}</tbody>
      </table>
    </section>
  `;
}

function renderProviderForm(provider = {}) {
  return `
    <div class="form-grid">
      <div>
        <label>Name</label>
        <input id="provider-name" value="${provider.name || ''}" />
      </div>
      <div>
        <label>Email</label>
        <input id="provider-email" value="${provider.email || ''}" />
      </div>
      <div>
        <label>Phone</label>
        <input id="provider-phone" value="${provider.phone || ''}" />
      </div>
      <div>
        <label>Address</label>
        <input id="provider-address" value="${provider.address || ''}" />
      </div>
      <div>
        <label>Notes</label>
        <textarea id="provider-notes">${provider.notes || ''}</textarea>
      </div>
    </div>
    <div>
      <button class="button" onclick="saveProvider(${provider.id || ''})">${provider.id ? 'Update' : 'Add'} Provider</button>
    </div>
  `;
}

function renderProducts() {
  const providerOptions = AppState.providers
    .map(provider => `<option value="${provider.id}">${provider.name}</option>`)
    .join('');
  const stockUsage = getStockUsage();

  const rows = AppState.products.map(product => `
    <tr>
      <td>${product.name}</td>
      <td>${product.sku}</td>
      <td>${formatCurrency(product.price)}</td>
      <td>${product.stock}</td>
      <td>${Math.max(0, (Number(product.stock) || 0) - (stockUsage[product.id] || 0))}</td>
      <td>${getProviderName(product.providerId)}</td>
      <td class="actions">
        <button class="button secondary" onclick="editProduct(${product.id})">Edit</button>
        <button class="button secondary" onclick="removeProduct(${product.id})">Delete</button>
      </td>
    </tr>
  `).join('');

  return `
    <section class="panel">
      <h2>Products</h2>
      <div class="form-grid">
        <div>
          <label>Name</label>
          <input id="product-name" />
        </div>
        <div>
          <label>SKU</label>
          <input id="product-sku" />
        </div>
        <div>
          <label>Price</label>
          <input id="product-price" type="number" step="0.01" />
        </div>
        <div>
          <label>Stock</label>
          <input id="product-stock" type="number" step="1" />
        </div>
        <div>
          <label>Provider</label>
          <select id="product-provider">
            <option value="">Select provider</option>
            ${providerOptions}
          </select>
        </div>
        <div>
          <label>Notes</label>
          <textarea id="product-notes"></textarea>
        </div>
      </div>
      <button class="button" onclick="saveProduct()">Add Product</button>
    </section>
    <section class="panel">
      <table>
        <thead>
          <tr><th>Name</th><th>SKU</th><th>Price</th><th>Stock</th><th>Available</th><th>Provider</th><th>Actions</th></tr>
        </thead>
        <tbody>${rows || '<tr><td colspan="7">No products yet.</td></tr>'}</tbody>
      </table>
    </section>
  `;
}

function renderDocuments() {
  const clientOptions = AppState.clients
    .map(client => `<option value="${client.id}">${client.name}</option>`)
    .join('');
  const productOptions = AppState.products
    .map(product => `<option value="${product.id}">${product.name}</option>`)
    .join('');
  const typeOptions = (AppState.documentTypes.length ? AppState.documentTypes : [
    { type: 'bon de commande' },
    { type: 'tax' },
    { type: 'devis' },
    { type: 'bt' }
  ])
    .map(item => `<option value="${item.type}">${item.type}</option>`)
    .join('');
  const statusOptions = (AppState.documentStatuses.length ? AppState.documentStatuses : ['draft', 'sent', 'paid', 'cancelled'])
    .map(status => `<option value="${status}">${status}</option>`)
    .join('');

  const rows = AppState.documents.map(doc => `
    <tr>
      <td>${doc.id}</td>
      <td>${getClientName(doc.clientId)}</td>
      <td><span class="pill">${doc.type}</span></td>
      <td>${doc.date}</td>
      <td>${doc.status}</td>
      <td>${formatCurrency(doc.total)}</td>
      <td class="actions">
        <button class="button secondary" onclick="editDocument(${doc.id})">Edit</button>
        <button class="button secondary" onclick="removeDocument(${doc.id})">Delete</button>
      </td>
    </tr>
  `).join('');

  return `
    <section class="panel">
      <h2>Document Overview</h2>
      ${renderDocumentCharts()}
    </section>
    <section class="panel">
      <h2>Documents</h2>
      <div class="form-grid">
        <div>
          <label>Client</label>
          <select id="doc-client">
            <option value="">Select client</option>
            ${clientOptions}
          </select>
        </div>
        <div>
          <label>Type</label>
          <select id="doc-type">
            ${typeOptions}
          </select>
        </div>
        <div>
          <label>Date</label>
          <input id="doc-date" type="date" />
        </div>
        <div>
          <label>Status</label>
          <select id="doc-status">
            ${statusOptions}
          </select>
        </div>
        <div>
          <label>Doc Link</label>
          <input id="doc-link" />
        </div>
        <div>
          <label>Notes</label>
          <textarea id="doc-notes"></textarea>
        </div>
      </div>
      <div class="panel" style="margin-top: 12px;">
        <h2>Line Items</h2>
        <div class="form-grid">
          <div>
            <label>Product</label>
          <select id="item-product" onchange="prefillLineItem()">
            <option value="">Select product</option>
            ${productOptions}
          </select>
        </div>
          <div>
            <label>Description</label>
            <input id="item-description" />
          </div>
          <div>
            <label>Quantity</label>
            <input id="item-qty" type="number" step="1" />
          </div>
          <div>
            <label>Unit Price</label>
            <input id="item-price" type="number" step="0.01" />
          </div>
        </div>
        <button class="button secondary" onclick="addLineItem()">Add Line Item</button>
        <div id="line-items" style="margin-top: 12px;"></div>
      </div>
      <button class="button" onclick="saveDocument()">Save Document</button>
    </section>
    <section class="panel">
      <table>
        <thead>
          <tr><th>ID</th><th>Client</th><th>Type</th><th>Date</th><th>Status</th><th>Total</th><th>Actions</th></tr>
        </thead>
        <tbody>${rows || '<tr><td colspan="7">No documents yet.</td></tr>'}</tbody>
      </table>
    </section>
  `;
}

let DraftItems = [];
function addLineItem() {
  const productId = document.getElementById('item-product').value;
  const product = AppState.products.find(item => String(item.id) === String(productId));
  const descriptionInput = document.getElementById('item-description');
  const priceInput = document.getElementById('item-price');
  const description = descriptionInput.value || (product ? product.name : '');
  const quantity = Number(document.getElementById('item-qty').value || 0);
  const unitPrice = Number(priceInput.value || (product ? product.price : 0));
  const lineTotal = quantity * unitPrice;
  DraftItems.push({ productId, description, quantity, unitPrice, lineTotal });
  renderLineItems();
}

function prefillLineItem() {
  const productId = document.getElementById('item-product').value;
  const product = AppState.products.find(item => String(item.id) === String(productId));
  if (!product) return;
  const descriptionInput = document.getElementById('item-description');
  const priceInput = document.getElementById('item-price');
  descriptionInput.value = product.name || '';
  priceInput.value = product.price || 0;
}

function renderLineItems() {
  const container = document.getElementById('line-items');
  if (!container) return;
  if (!DraftItems.length) {
    container.innerHTML = '<p>No line items yet.</p>';
    return;
  }
  container.innerHTML = `
    <table>
      <thead>
        <tr><th>Product</th><th>Description</th><th>Qty</th><th>Unit Price</th><th>Total</th><th>Action</th></tr>
      </thead>
      <tbody>
        ${DraftItems.map((item, index) => `
          <tr>
            <td>${getProductName(item.productId)}</td>
            <td>${item.description}</td>
            <td>${item.quantity}</td>
            <td>${formatCurrency(item.unitPrice)}</td>
            <td>${formatCurrency(item.lineTotal)}</td>
            <td><button class="button secondary" onclick="removeLineItem(${index})">Remove</button></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function removeLineItem(index) {
  DraftItems.splice(index, 1);
  renderLineItems();
}

function getClientName(clientId) {
  const client = AppState.clients.find(item => String(item.id) === String(clientId));
  return client ? client.name : 'Unknown';
}

function getProviderName(providerId) {
  const provider = AppState.providers.find(item => String(item.id) === String(providerId));
  return provider ? provider.name : '-';
}

function getProductName(productId) {
  const product = AppState.products.find(item => String(item.id) === String(productId));
  return product ? product.name : '-';
}

function getStockUsage() {
  const typesWithStock = new Set(
    (AppState.documentTypes || [])
      .filter(item => item.reducesStock)
      .map(item => String(item.type))
  );
  const documentsMap = new Map();
  AppState.documents.forEach(doc => {
    documentsMap.set(String(doc.id), doc);
  });
  const usage = {};
  AppState.documentItems.forEach(item => {
    const doc = documentsMap.get(String(item.documentId));
    if (!doc || !typesWithStock.has(String(doc.type))) return;
    const key = String(item.productId);
    usage[key] = (usage[key] || 0) + (Number(item.quantity) || 0);
  });
  return usage;
}

function renderDocumentCharts() {
  if (!AppState.documents.length) {
    return '<p>No documents yet.</p>';
  }

  const byType = {};
  const byMonth = {};
  const revenueByMonth = {};
  AppState.documents.forEach(doc => {
    const typeKey = doc.type || 'unknown';
    byType[typeKey] = (byType[typeKey] || 0) + 1;

    const dateKey = (doc.date || '').slice(0, 7) || 'unknown';
    byMonth[dateKey] = (byMonth[dateKey] || 0) + 1;
    revenueByMonth[dateKey] = (revenueByMonth[dateKey] || 0) + (Number(doc.total) || 0);
  });

  return `
    <div class="charts-grid">
      <div class="panel">
        <h2>Documents by Type</h2>
        ${renderBarChart(byType)}
      </div>
      <div class="panel">
        <h2>Documents per Month</h2>
        ${renderBarChart(byMonth)}
      </div>
      <div class="panel">
        <h2>Revenue per Month</h2>
        ${renderBarChart(revenueByMonth, true)}
      </div>
    </div>
  `;
}

function renderBarChart(dataMap, formatMoney) {
  const entries = Object.entries(dataMap)
    .sort(([a], [b]) => a.localeCompare(b));
  if (!entries.length) {
    return '<p>No data.</p>';
  }
  const maxValue = Math.max(...entries.map(([, value]) => value));
  return `
    <div class="chart">
      ${entries.map(([label, value]) => `
        <div class="chart-row">
          <div>${label}</div>
          <div class="chart-bar"><span style="width: ${(value / maxValue) * 100}%"></span></div>
          <div>${formatMoney ? formatCurrency(value) : value}</div>
        </div>
      `).join('')}
    </div>
  `;
}

async function loadAppData() {
  const data = await API.getAppData();
  AppState.clients = data.clients || [];
  AppState.providers = data.providers || [];
  AppState.products = data.products || [];
  AppState.documents = data.documents || [];
  AppState.documentItems = data.documentItems || [];
  AppState.documentTypes = data.documentTypes || [];
  AppState.documentStatuses = data.documentStatuses || [];
  renderApp();
  renderLineItems();
}

function snapshotState() {
  return JSON.parse(JSON.stringify({
    view: AppState.view,
    clients: AppState.clients,
    providers: AppState.providers,
    products: AppState.products,
    documents: AppState.documents,
    documentItems: AppState.documentItems,
    isSaving: AppState.isSaving,
    errorMessage: AppState.errorMessage
  }));
}

function restoreState(snapshot) {
  AppState.view = snapshot.view;
  AppState.clients = snapshot.clients;
  AppState.providers = snapshot.providers;
  AppState.products = snapshot.products;
  AppState.documents = snapshot.documents;
  AppState.documentItems = snapshot.documentItems;
  AppState.isSaving = snapshot.isSaving;
  AppState.errorMessage = snapshot.errorMessage;
}

async function runWithOptimistic(updateFn, action) {
  const snapshot = snapshotState();
  AppState.isSaving = true;
  AppState.errorMessage = '';
  updateFn();
  renderApp();
  renderLineItems();
  try {
    await action();
    AppState.isSaving = false;
    await loadAppData();
  } catch (error) {
    restoreState(snapshot);
    AppState.isSaving = false;
    AppState.errorMessage = 'Save failed. Changes were reverted.';
    renderApp();
    renderLineItems();
  }
}

async function saveClient(id) {
  const payload = {
    id: id ? Number(id) : undefined,
    name: document.getElementById('client-name').value,
    email: document.getElementById('client-email').value,
    phone: document.getElementById('client-phone').value,
    address: document.getElementById('client-address').value,
    notes: document.getElementById('client-notes').value
  };
  await runWithOptimistic(() => {
    if (id) {
      AppState.clients = AppState.clients.map(client =>
        client.id === payload.id ? { ...client, ...payload } : client
      );
    } else {
      const tempId = `temp-${Date.now()}`;
      AppState.clients = [{ ...payload, id: tempId }, ...AppState.clients];
    }
  }, () => id ? API.updateClient(payload) : API.addClient(payload));
}

async function removeClient(id) {
  await runWithOptimistic(() => {
    AppState.clients = AppState.clients.filter(client => client.id !== id);
  }, () => API.deleteClient(id));
}

function editClient(id) {
  const client = AppState.clients.find(item => item.id === id);
  if (!client) return;
  const panel = document.querySelector('.panel');
  panel.innerHTML = `<h2>Clients</h2>${renderClientForm(client)}`;
}

async function saveProvider(id) {
  const payload = {
    id: id ? Number(id) : undefined,
    name: document.getElementById('provider-name').value,
    email: document.getElementById('provider-email').value,
    phone: document.getElementById('provider-phone').value,
    address: document.getElementById('provider-address').value,
    notes: document.getElementById('provider-notes').value
  };
  await runWithOptimistic(() => {
    if (id) {
      AppState.providers = AppState.providers.map(provider =>
        provider.id === payload.id ? { ...provider, ...payload } : provider
      );
    } else {
      const tempId = `temp-${Date.now()}`;
      AppState.providers = [{ ...payload, id: tempId }, ...AppState.providers];
    }
  }, () => id ? API.updateProvider(payload) : API.addProvider(payload));
}

async function removeProvider(id) {
  await runWithOptimistic(() => {
    AppState.providers = AppState.providers.filter(provider => provider.id !== id);
  }, () => API.deleteProvider(id));
}

function editProvider(id) {
  const provider = AppState.providers.find(item => item.id === id);
  if (!provider) return;
  const panel = document.querySelector('.panel');
  panel.innerHTML = `<h2>Providers</h2>${renderProviderForm(provider)}`;
}

async function saveProduct(id) {
  const payload = {
    id: id ? Number(id) : undefined,
    name: document.getElementById('product-name').value,
    sku: document.getElementById('product-sku').value,
    price: Number(document.getElementById('product-price').value || 0),
    stock: Number(document.getElementById('product-stock').value || 0),
    providerId: document.getElementById('product-provider').value,
    notes: document.getElementById('product-notes').value
  };
  await runWithOptimistic(() => {
    if (id) {
      AppState.products = AppState.products.map(product =>
        product.id === payload.id ? { ...product, ...payload } : product
      );
    } else {
      const tempId = `temp-${Date.now()}`;
      AppState.products = [{ ...payload, id: tempId }, ...AppState.products];
    }
  }, () => id ? API.updateProduct(payload) : API.addProduct(payload));
}

async function removeProduct(id) {
  await runWithOptimistic(() => {
    AppState.products = AppState.products.filter(product => product.id !== id);
  }, () => API.deleteProduct(id));
}

function editProduct(id) {
  const product = AppState.products.find(item => item.id === id);
  if (!product) return;
  document.getElementById('product-name').value = product.name || '';
  document.getElementById('product-sku').value = product.sku || '';
  document.getElementById('product-price').value = product.price || 0;
  document.getElementById('product-stock').value = product.stock || 0;
  document.getElementById('product-provider').value = product.providerId || '';
  document.getElementById('product-notes').value = product.notes || '';
  const button = document.querySelector('.panel .button');
  button.textContent = 'Update Product';
  button.onclick = () => saveProduct(product.id);
}

async function saveDocument(id) {
  const payload = {
    id: id ? Number(id) : undefined,
    clientId: document.getElementById('doc-client').value,
    type: document.getElementById('doc-type').value,
    date: document.getElementById('doc-date').value,
    status: document.getElementById('doc-status').value,
    docLink: document.getElementById('doc-link').value,
    notes: document.getElementById('doc-notes').value
  };
  const items = DraftItems.map(item => ({
    ...item,
    lineTotal: item.quantity * item.unitPrice
  }));
  await runWithOptimistic(() => {
    const total = items.reduce((sum, item) => sum + (Number(item.lineTotal) || 0), 0);
    if (id) {
      AppState.documents = AppState.documents.map(doc =>
        doc.id === payload.id ? { ...doc, ...payload, total } : doc
      );
      AppState.documentItems = AppState.documentItems.filter(item => item.documentId !== payload.id)
        .concat(items.map((item) => ({
          ...item,
          id: `temp-${Date.now()}-${Math.random()}`,
          documentId: payload.id
        })));
    } else {
      const tempId = `temp-${Date.now()}`;
      AppState.documents = [{ ...payload, id: tempId, total }, ...AppState.documents];
      AppState.documentItems = AppState.documentItems.concat(items.map((item) => ({
        ...item,
        id: `temp-${Date.now()}-${Math.random()}`,
        documentId: tempId
      })));
    }
  }, () => id ? API.updateDocument(payload, items) : API.addDocument(payload, items));
  DraftItems = [];
}

async function removeDocument(id) {
  await runWithOptimistic(() => {
    AppState.documents = AppState.documents.filter(doc => doc.id !== id);
    AppState.documentItems = AppState.documentItems.filter(item => item.documentId !== id);
  }, () => API.deleteDocument(id));
}

function editDocument(id) {
  const doc = AppState.documents.find(item => item.id === id);
  if (!doc) return;
  DraftItems = AppState.documentItems.filter(item => item.documentId === id).map(item => ({
    productId: item.productId,
    description: item.description,
    quantity: item.quantity,
    unitPrice: item.unitPrice,
    lineTotal: item.lineTotal
  }));
  document.getElementById('doc-client').value = doc.clientId || '';
  document.getElementById('doc-type').value = doc.type || '';
  document.getElementById('doc-date').value = doc.date || '';
  document.getElementById('doc-status').value = doc.status || '';
  document.getElementById('doc-link').value = doc.docLink || '';
  document.getElementById('doc-notes').value = doc.notes || '';
  const button = document.querySelector('.panel > .button');
  button.textContent = 'Update Document';
  button.onclick = () => saveDocument(doc.id);
  renderLineItems();
}

loadAppData();
</script>
